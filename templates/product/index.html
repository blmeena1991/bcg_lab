{% extends "base_products.html" %}
{% load paginator filters %}
{% block product_list %}active{% endblock %}
{% block header %}
	<h1>Gestion des produits</h1>
	<h3>{{ product_count }} produits référencés.</h3>
{% endblock %}

{% block content %}
<h2 style="padding-bottom: 3px;border-bottom: 1px solid #e1ddda;">Recherche rapide</h2>
<form method="GET" action="." class="search show_wait">
	<fieldset>
		<input type="text" name="q" value="{{q_init}}"/> <input type="submit" value=" " />
		<p style="margin-left:10px">&rarr;&nbsp;{{search_count}} produit{{search_count|pluralize}} trouvé{{search_count|pluralize}}</p>
	</fieldset>
</form>
<div class="cleaner"></div>
<div class="saving">
	<img src="{{ MEDIA_URL }}img/layout/wait.gif" />
</div>

{% if products.object_list|length > 0 %}
	{% if not user|has_perm:"order.custom_view_local_provider" %}
	<div class="btn_wrapper hide_on_save">
		<a href="{% url tab_cart %}" class="btn_medium">
			<img src="{{ MEDIA_URL }}img/icons/cart_go.png" />Voir le panier
		</a>
	</div>
	{% endif %}
	{% if search_count > 0 %}
	<div class="btn_wrapper hide_on_save">
		<a href="{% url product_edit_list %}?{{url_args}}" class="btn_big">
			<img src="{{ MEDIA_URL }}img/icons/pencil.png" />Editer cette liste de produits
		</a>
	</div>
	{% endif %}
	<div class="btn_wrapper hide_on_save">
		<a href="{% url product_export_xls %}?{{url_args}}" class="btn_big">
			<img src="{{ MEDIA_URL }}img/icons/page_excel.png" />Exporter cette liste
		</a>
	</div>
	
	<div class="cleaner"></div>
	<div style="color:#e2350d;height:20px" class="hide_on_save">
		<div class="legend_urgent"></div>offre périmée
	</div>
	<div class="cleaner"></div>
	<table class="list">
		<thead>
				<th>Fournisseur</th>
				<th style="max-width:200px">produit</th>
				<th>Cond.</th>
				<th>Réf.</th>
				<th>Prix</th>
				<th>N° Offre</th>
				<th>Expiration</th>
				<th>Nomen.</th>
				<th>MAJ</th>
				<th>Action</th>
		</thead>
		<tbody>
			{% for product in products.object_list %}
				<tr class="{% cycle 'even' 'odd' %} {% if product.has_expired %}expired{% else %}{% if product.soon_expired %}soon_expired{% endif %}{% endif %}">
					<td>{{ product.provider.name }}{% if product.origin %} - {{ product.origin }}{% endif %}</td>
					<td>{{ product.name }}</td>
					<td>{{ product.packaging|default:"" }}</td>
					<td>{{ product.reference }}</td>
					<td>{{ product.price }}&nbsp;€</td>
					<td>{{ product.offer_nb|default:"" }}</td>
					<td>{{ product.expiry|date }}</td>
					<td>{{ product.nomenclature|default:"" }}</td>
					<td>{{ product.last_change|date }}</td>
					<td style="white-space:nowrap">
						{% if not product.has_expired %}
							{% if not user|has_perm:"order.custom_view_local_provider" %}
							<button id="{{product.id}}" class="plus addToCart">Panier</button>
							{% endif %}
						{% endif %}
						<a href="{% url product_item product.id %}?{{url_args}}" class="pencil">Editer</a>
					</td>
				</tr>
			{% endfor %}
		</tbody>
	</table>
	
	{% pagination products %}
{% else %}
	{% if not user|has_perm:"order.custom_view_local_provider" %}
	<h2 style="padding-bottom: 3px;border-bottom: 1px solid #e1ddda;" class="hide_on_save">Recherche avancée</h2>
	<form action="{% url product_index %}" method="GET" class="show_wait hide_on_save">
		<fieldset>
			<strong>Chercher les produits qui correspondent à {{ filter_form.connector }} conditions suivantes:</strong>
			{% with filter_form.provider as field %}
				{% include "form_snippet.html" %}
			{% endwith %}
			{% with filter_form.origin as field %}
				{% include "form_snippet.html" %}
			{% endwith %}
			{% with filter_form.name__icontains as field %}
				{% include "form_snippet.html" %}
			{% endwith %}
			{% with filter_form.reference as field %}
				{% include "form_snippet.html" %}
			{% endwith %}
			{% with filter_form.nomenclature as field %}
				{% include "form_snippet.html" %}
			{% endwith %}
			{% with filter_form.category as field %}
				{% include "form_snippet.html" %}
			{% endwith %}
			{% with filter_form.sub_category as field %}
				{% include "form_snippet.html" %}
			{% endwith %}
	
			<div class="cleaner"></div>
			<button type="submit" class="all">Chercher</button>
		</fieldset>
	</form>
	{% endif %}
{% endif %}

<div id="addToCart" class="dialog" title="Saisissez la quantité à commander">
	<div class="show_expired_warning">
		ATTENTION: l'offre sur ce produit a atteint sa date d'expiration
		<br /><br />
	</div>	
	<div class="cleaner"></div>
	<form action="{% url cart_add %}" method="POST" style="padding:0">{% csrf_token %}
		<input type="hidden" name="url_params" value="{{url_args}}" />
		<input type="hidden" name="product_id" value="" />
		<div id="qty-error-msg"></div>
		<label for="quantity">Quantité:</label>
		<input type="text" name="quantity" value="" />
		<div class="cleaner"></div>
	</form>
</div>

{% endblock %}
